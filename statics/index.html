<!DOCTYPE html><html>	<head>		<meta charset='utf-8'>		<title>msg board test</title>		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>		<style type="text/css">			body{				width:600px;				margin:0px auto;			}			.message{						padding:5px;				border-bottom:1px dotted #333;			}			.odd{				background:#eef;			}			.message .name{				font-weight:bold;			}			.message .time{				color:#555;			}			.message .content{				word-wrap:break-word; word-break:break-all;			}			#status{				font-size:10px;				color:#555;				font-family:verdana;			}			.info{				float:left;							}			.msgcnt{				float:left;			}			.clear{				clear:both;			}			.say{				color:white;				background:	#FF7F24 ;				padding:2px;			}		</style>	</head>		<body>		<h1> Long pulling chat room </h1>		<hr />		<fieldset><legend>My Message</legend>			<form id="msgform" onsubmit="putmsg();return false;">				<span id="mynick"></span><span class="say">說</span>：				<input type="text" name="mymsg" id="mymsg" size="60" />				<input type="hidden" name="nick" id="nick" value='' />				<input type="button" value="send" onclick="putmsg()" />			</form>		</fieldset><br />		<fieldset><legend>Messages:</legend>			<div id="status"></div>			<div id="messages"></div>		</fieldset>		<div class="msg" style="display:none;">			<div class="info">				<span class="time"></span>				<span class="name"></span>				<span class="say">說</span>：			</div>			<div class="msgcnt">				<span class="content"></span>			</div>			<div class="clear"></div>					</div><br />		<script type="text/javascript">			var lastupdate;			var nickname = window.prompt("What's Your Nick Name?");			var flag = true;			$("#nick").val(nickname);			$("#mynick").text(nickname);			function pullmsg(){				$("#status").text("Pulling ALL msg...");				$.getJSON("/pullmsg",function (json){					handlemsg(json);					update(); // Start Long pooling					$("#status").text("Pulling NEW msg...");				});			}			function update(){				$("#status").text("Pulling NEW msg...");				/*$.post('/getnewer',{lastmod:lastupdate}, function(response) {					handlemsg(response);					update();				}); // if timeout, it will not repeat  */				$.ajax({					type:"POST",					url: '/getnewer',					data: {'lastmod':lastupdate},										success:function(response){						if(response.length > 1){							handlemsg(response);						}						update();					},					error:function(jqXHR, textStatus, errorThrown){						update();						window.alert("AJAX ERR: " + errorThown + ", retrying ...");											}				});			}			function putmsg(){				$.post("/postmsg",$("#msgform").serialize());				$("#mymsg").val("");			}				function handlemsg(json){				$("#status").text("INSERTING msg...");				if(json.length < 1)	return;  // fix timeout problem				var msgs = json.messages;				lastupdate = json.lastmod;				$.each(msgs,function(key,msg){					var msgdiv = $(".msg").clone().attr('class','message').prependTo('#messages');					var msgtime = new Date(msg.time);					var h = msgtime.getHours();					var m = msgtime.getMinutes();					var s = msgtime.getSeconds();					msgdiv.find(".time").text("<" + h + ":" + m + ":" + s + "> ");					msgdiv.find(".name").text("" +msg.nick + "  ");					msgdiv.find(".content").html(striptag(msg.msg));					msgdiv.css('display','block');					if(flag){						msgdiv.addClass("odd");					}					flag = !flag;				});			}			function striptag(txt){				var tmp = txt.replace("&lt;","<").replace("&gt;",">");				try{					var link = $(tmp).attr("href");				}catch(e){					return txt;				}				if(!link){					return txt;				}else{					var mylink = document.createElement("a");					$(mylink).attr("href",link).attr("target","_blank").text($(tmp).text());					return mylink;									}			}			pullmsg();		</script>	</body></html>